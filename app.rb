require 'bundler/setup'
require 'sinatra'
require 'sinatra/reloader'
require 'faraday'

class App < Sinatra::Base

  configure :development do
    register Sinatra::Reloader
  end

  get '/callback' do
    status 400 unless valid_token?
    status 400 unless valid_user?

    @connection ||= Faraday.new(:url => 'https://api.getirkit.com')

    @connection.post do |req|
      req.url '/1/messages'
      req.body = {
        :clientkey => ENV['CLIENT_KEY'],
        :deviceid => ENV['DEVICE_ID'],
        :message => '{"format":"raw","freq":38,"data":[6881,3341,873,2537,873,2537,873,873,873,873,873,873,873,2537,873,873,873,873,873,2537,873,2537,873,873,873,2537,873,873,873,873,873,2537,873,2537,873,873,873,2537,873,2537,873,873,873,873,873,2537,873,873,873,873,873,2537,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,2537,873,873,873,873,873,873,873,873,873,873,873,2537,873,2537,873,873,873,873,873,873,873,873,873,873,873,2537,873,2537,873,873,873,873,873,873,873,873,873,873,873,2537,873,2537,873,873,873,2537,873,2537,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,2537,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,873,761,935,761,935,761,935,761,935,761,935,761,935,761,935,761,935,761,935,761,935,761,935,761,935,761,935,761,935,761,935,761,935,761,935,2451,935,2451,935,2451,935,2451,935,761,935,761,935,2451,935,2451,935,26325,6881,3228,935,2451,935,2451,935,761,935,761,935,761,935,2368,968,710,968,710,968,2368,968,2368,968,710,968,2368,968,710,968,710,968,2368,968,2368,968,710,968,2368,968,2368,968,710,968,710,968,2368,968,710,968,710,968,2368,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,2368,968,710,968,710,968,710,968,710,968,710,968,2368,968,2368,968,710,968,710,968,710,968,710,968,710,968,2368,968,2368,968,710,968,710,968,710,968,710,968,710,968,2368,968,2368,968,710,968,2368,968,2368,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,2368,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,710,968,2368,968,2368,968,2368,968,2368,968,710,968,710,968,2368,968,2368,968]}'
      }
    end
  end

  private
    
    def valid_token?
      params[:token] == ENV['API_KEY']
    end

    def valid_user?
      params[:username] == ENV['USER_NAME']
    end
end
